using System;
using System.Configuration;
using System.Data.SqlClient;
using System.Web;
using System.Xml;

namespace Malware_FYPJ.Entity
{
    public class ReportMod
    {
        // Variables
        private string sampleMD5;
        private int versionNo;
        private DateTime dateMod;
        private int modType;
        private string xpath;
        private Guid userId;

        // Encapsulated methods
        public string SampleMD5
        {
            get { return sampleMD5; }
            set { sampleMD5 = value; }
        }

        public int VersionNo
        {
            get { return versionNo; }
            set { versionNo = value; }
        }

        public DateTime DateMod
        {
            get { return dateMod; }
            set { dateMod = value; }
        }

        public int ModType
        {
            get { return modType; }
            set { modType = value; }
        }

        public string Xpath
        {
            get { return xpath; }
            set { xpath = value; }
        }

        public Guid UserId
        {
            get { return userId; }
            set { userId = value; }
        }

        public static string getPath(XmlNode node)
        {
            string path = "";
            while (node.NodeType != XmlNodeType.Document)
            {
                int sibCount = 0;
                XmlNode pn = node;
                while (pn != null)
                {
                    if (node.Name.Equals(pn.Name))
                    {
                        sibCount++;
                    }
                    pn = pn.PreviousSibling;
                }
                if (sibCount > 1)
                {
                    path = "/" + node.Name + "[" + sibCount + "]" + path;
                }
                else
                {
                    path = "/" + node.Name + path;
                }
                node = node.ParentNode;
            }
            return path;
        }

        public void recordMod(ReportMod rm)
        {
            rm.versionNo = 1;
            string query = "SELECT MAX([versionNo]) FROM reportmod WHERE [sampleMD5] = @sampelMD5;)";
            SqlConnection con = new SqlConnection(ConfigurationManager.ConnectionStrings["malwrConnectionString"].ToString());
            SqlCommand cmd = new SqlCommand(query, con);
            con.Open();
            cmd.Parameters.AddWithValue("@sampleMD5", rm.sampleMD5);

            SqlDataReader reader = cmd.ExecuteReader();
            if (reader.Read())
            {
                rm.versionNo = reader.GetInt32(0);
            }
            con.Close();

            query = "INSERT INTO reportmod VALUES (@sampleMD5, @versionNo, @dateMod, @modType, @xpath, @userID)";
            con = new SqlConnection(ConfigurationManager.ConnectionStrings["malwrConnectionString"].ToString());
            cmd = new SqlCommand(query, con);
            con.Open();
            cmd.Parameters.AddWithValue("@SampleMD5", rm.sampleMD5);
            cmd.Parameters.AddWithValue("@SampleName", rm.versionNo);
            cmd.Parameters.AddWithValue("@dateMod", rm.dateMod);
            cmd.Parameters.AddWithValue("@modType", rm.modType);
            cmd.Parameters.AddWithValue("@xpath", rm.xpath);
            cmd.Parameters.AddWithValue("@userID", rm.userId);
            cmd.ExecuteNonQuery();
            con.Close();
        }
    }
}
