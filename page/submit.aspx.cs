using Malware_FYPJ.Entity;
using Malware_FYPJ.webservice;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net;
using System.Security.Cryptography;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Windows.Forms;

namespace Malware_FYPJ.page
{
    public partial class submit : System.Web.UI.Page
    {
        int sizeLimit = 2000000;
        protected void Page_Load(object sender, EventArgs e)
        {
        }

        protected void BtnUpload_Click(object sender, EventArgs e)
        {
            if (FileUpload.HasFile && FileUpload.PostedFile.ContentLength < sizeLimit && Membership.GetUser() != null)
            {
                Guid username = (Guid)Membership.GetUser().ProviderUserKey;
                string file_name = FileUpload.FileName;
                byte[] file_content = FileUpload.FileBytes;
                string fileExtension = Path.GetExtension(this.FileUpload.FileName);
                Submit submit = new Submit();
                string status = submit.SubmitSample(file_name, file_content, username, fileExtension);
                StatusLabel.Text = status;
                
                string country, ip, city;
                country = "";
                ip = "";
                city = "";

                using (StringReader reader = new StringReader(Getuserinfo()))
                {
                    string line;
                    while ((line = reader.ReadLine()) != null)
                    {
                        if (line.Contains("Country"))
                        {
                            country = line;
                        }
                        if (line.Contains("City"))
                        {
                            city = line;
                        }
                        if (line.Contains("IP"))
                        {
                            ip = line;
                        }

                    }
                }

                GetInfo get = new GetInfo();
                get.Username = System.Web.HttpContext.Current.User.Identity.Name;
                get.Comname = System.Net.Dns.GetHostName();
                get.City = city;
                get.Country = country;
                get.IP = ip;
                get.Time = DateTime.Now.ToString();
                get.App = "Web";
                get.Download = "";
                get.Upload = file_name;

                GetInfo.insertlog(get);


            }
            else if (!FileUpload.HasFile)
            {
                StatusLabel.Text = "Error: Please select a file.";
            }
            else if (!(FileUpload.PostedFile.ContentLength < sizeLimit))
            {
                StatusLabel.Text = "Error: File must be under 2MB.";
            }
            else if (Membership.GetUser() == null)
            {
                StatusLabel.Text = "Error: You must be logged in to submit sample.";
            }
        }

        static public string Getuserinfo()
        {
            Info req = new Info();
            req.Request("http://checkip.dyndns.org");
            string[] a = req.ResponseBody.Split(':');
            string a2 = a[1].Substring(1);
            string[] a3 = a2.Split('<');
            string a4 = a3[0];

            return new WebClient().DownloadString("http://api.hostip.info/get_html.php?ip=" + a4);
        }

    }
}